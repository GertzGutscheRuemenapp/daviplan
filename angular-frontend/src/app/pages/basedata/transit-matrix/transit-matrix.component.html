<div class="loadOverlay" *ngIf="isLoading$ | async" xmlns="http://www.w3.org/1999/html">
  <mat-spinner [diameter]="50"></mat-spinner>
</div>
<app-header-card [title]="'ÖPNV-Netz: Reisezeiten zu den Einrichtungen mit Bus und Bahn'"
                 cookieId="exp-reach-header"
                 width="1170px">
  <p>Wie schon im vorigen Menüpunkt beschrieben werden die Erreichbarkeitsverhältnisse in Ihrem Planungsraum anhand von Erreichbarkeitsmatrizen abgebildet.</p>
  <p>Erreichbarkeitsmatrizen sind (große) Tabellen, in denen für ein bestimmtes Verkehrsmittel verzeichnet ist, wie lange man mit diesem von Teilfläche A zu Teilfläche B braucht. Die Teilflächen entsprechend dabei dem europaweit standardisierten 100x100-Meter-LAEA-Raster, auf das bereits im Menüpunkt „Einwohnerraster“ Bezug genommen wurde.</p>
  <p>Diese Erreichbarkeitsmatrizen können Sie auf dieser Seite für die vier Verkehrsmittel „zu Fuß“, „Fahrrad“, „Auto“ und „ÖPNV“ zusammentragen. Dabei können Sie entweder extern vorberechnete Erreichbarkeitsmatrizen hochladen. Alternativ können Sie alle oder einzelne Erreichbarkeitsmatrizen mit einem oder mehreren im vorigen Menüpunkt „Verkehrsnetz“ erzeugten Verkehrsnetzen und deren Routensuchern berechnen.</p>
  <p>Erzeugen Sie nach Möglichkeit für jedes Verkehrsmittel eine Erreichbarkeitsmatrix. Wenn Sie für ein Verkehrsmittel unterschiedliche Entwicklungszustände (z.B. „aktueller Fahrplan“, „geplanter Fahrplan“ oder „mit/ohne neue Ortsumgehung“) abbilden möchten, können Sie für einzelne Verkehrsmittel auch mehrere Erreichbarkeitsmatrizen für die Nutzer*innen des Hauptmenübereichs „Infrastrukturplanung“ bereitstellen. Diese unterschiedlichen Versionen der regionalen Erreichbarkeit können von den Nutzer*innen dann alternativ in ihre Szenarienbetrachtungen integriert werden.</p>
  <p>Um eine Erreichbarkeitsmatrix zu erzeugen, wählen Sie in der Box „Verkehrsmittel“ zunächst das Verkehrsmittel aus, für das sie eine Erreichbarkeitsmatrix hinzufügen oder erzeugen wollen. Klicken Sie dann auf „Hinzufügen“.</p>
  <p>Gehen Sie anschließend zur Box „Ausgewählte Erreichbarkeitsmatrix“. Hier können Sie die Daten dieser Matrix (aus einer externen Vorberechnung) hochladen oder mit Hilfe eines im Menüpunkt „Verkehrsnetz“ erzeugten Routensuchers berechnen. Detail hierzu finden Sie im Hilfetext der Box.</p>
</app-header-card>
<app-status-card *ngIf="isProcessing">
  Es läuft gerade eine Berechnung im Bereich „Erreichbarkeiten“
</app-status-card>
<div fxLayout="row wrap">
  <app-input-card [title]="'ÖPNV-Netze'"
                  subtitle="ÖPNV-Netz hinzufügen oder auswählen"
                  width="300px"
                  infoText="<p> Klicken Sie auf „Hinzufügen“ um ein ÖPNV-Netz zu definieren. Geben Sie diesem in dem sich dann öffnenden Dialog einen Namen, z.B. „Aktueller Fahrplan, werktags vormittags“. Wählen Sie dieses Netz anschließen in der Liste der ÖPNV-Netz aus, indem Sie es anklicken. Daraufhin erscheinen weitere Eingabeboxen. </p>
                  <p> Optional können Sie mehrere ÖPNV-Netze definieren, z.B. um unterschiedliche Zeiträume (Tageszeiten, Werktags, Wochenende) oder Planungsvarianten (aktueller Fahrplan, zukünftiger Fahrplan) abzubilden. </p>
                  <p> Wenn Sie mehrere Netze definiert haben, müssen Sie eines als Standardannahme auswählen. Dieses ÖPNV-Netz liegt dann allen automatisch generierten Szenarien „Trendfortschreibung“ im Anwendungsbereich „Infrastrukturplanung“ zugrunde. </p>">
    <mat-selection-list [multiple]="false"
                        class="categorized"
                        id="mode-select">
      <mat-list-option *ngFor="let variant of variants"
                       (click)="selectVariant(variant);"
                       [selected]="(selectedVariant?.id === variant.id)">
        <div class="option-text">{{variant.label}}</div>
        <mat-icon *ngIf="variant.isDefault" style="color: #2196F3; position: absolute; right: 0; top: 8px; font-size: 1.2em;">verified</mat-icon>
      </mat-list-option>
    </mat-selection-list>
    <button mat-button color="primary"
            class="multiline-button"
            (click)="onSetAsDefault()">
<!--              (click)="statusQuoRouters[selectedRouter.mode] = (statusQuoRouters[selectedRouter.mode]===selectedRouter.id)? undefined : selectedRouter.id">-->
      <mat-icon class="material-icons-outlined">verified</mat-icon>
      Als Annahme für Trendfortschreibung festlegen
    </button>
    <div>
      <button mat-button color="primary"
              class="mat-button-dv"
              (click)="onEditVariant(true)">
        <mat-icon>add</mat-icon>hinzufügen
      </button>
      <button mat-button color="primary"
              style="float: right;"
              class="mat-button-dv"
              (click)="onDeleteVariant()">
        <!--                [disabled]="selectedQuota==='aktuelle Quoten'"-->
        <mat-icon>close</mat-icon>entfernen
      </button>
    </div>
    <div>
      <button mat-button color="primary"
              class="mat-button-dv"
              (click)="onEditVariant()">
        <mat-icon>edit</mat-icon>bearbeiten
      </button>
    </div>
  </app-input-card>
  <div fxLayout="column">
    <app-input-card [title]="'Schritt 1: Haltestellen'"
                    [disabled]="isProcessing"
                    [class.hidden]="!selectedVariant"
                    width="450px"
                    infoText="<p>Für das ausgewählte ÖPNV-Netz können Sie hier eine Liste der Haltestellen in ihrem Planungsraum hochladen. Bitte nutzen Sie hierfür die Excel-Vorlage, die Sie sich über die Schaltfläche „Vorlage Haltestellen“ herunterladen können. </p>
                    <p>Jede Haltestelle braucht neben ihrem Namen eine eindeutige Nummer sowie eine Geokoordinate. </p>
                    <p>Sofern Sie oder einer Ihrer Dienstleister/innen über das Programm VISUM verfügt, können die Haltestellenliste direkt aus VISUM exportieren und in daviplan einlesen. Hierzu finden Sie über die Schaltfläche „Anleitung VISUM-Datenexport“ in der Eingabebox zu Schritt 2 sowie im daviplan-Handbuch eine detaillierte Anleitung. </p>">
      <span class="subtitle1 sub">
        Haltestellen für „{{selectedVariant?.label}}“
      </span>
      <table>
        <tr>
          <td i18n>Anzahl Haltestellen: </td>
          <td>{{statistics?.nStops?.toLocaleString() || '-'}}</td>
        </tr>
      </table>
      <div style="display: flex; margin-top: 10px;">
        <button mat-stroked-button color="primary" style="margin-right: 10px;" (click)="downloadTemplate()">
          <mat-icon>download</mat-icon> Vorlage Haltestellen
        </button>
        <button mat-flat-button color="primary" (click)="uploadStops()">
          <mat-icon>upload</mat-icon> Haltestellen hochladen
        </button>
      </div>
    </app-input-card>
    <app-input-card [title]="'Schritt 2: Fahrzeiten zwischen den Haltestellen'"
                    [disabled]="isProcessing"
                    [class.hidden]="!selectedVariant"
                    width="450px"
                    infoText= "<p> In dieser Eingabebox wird eine Liste der Reisezeiten zwischen den in Schritt 1 definierten Haltestellen von Ihnen erwartet. Hierfür können Sie sich über die Schaltfläche „Vorlage Fahrzeitenliste“ eine Excel-Vorlage herunterladen und diese anschließend befüllt wieder hochladen. </p
                    <p>In der erwarteten Liste geben Sie an, von welcher Haltestelle (= Haltestelle-Nummer aus Schritt 1) zu welcher Haltestelle (ebenfalls Haltestelle-Nummer aus Schritt 1) man wie viele Minuten (inkl. Umstiegszeiten, aber ohne Wartezeit an der Starthaltestelle) unterwegs ist. </p>
                    <p>Sie können dabei selbst entscheiden, ob Sie die schnellste, die mittlere oder die häufigste Reisezeit angeben. Wenn sich die Reisezeiten an unterschiedlichen Tagen oder Tageszeiten deutlich unterscheiden, ist es sinnvoll, mehrere Netze zu definieren (Schritt 0). </p>
                    <p>Sofern Sie, Ihr ÖPNV-Unternehmen, Ihr Verkehrsverbund oder ein für Sie tätiges Planungsbüro über das Programm VISUM verfügt, können Sie sowohl die Haltestellenliste (Schritt 1) als auch die Liste der Liste der Fahrzeiten (Schritt 2) direkt aus VISUM exportieren und in daviplan einlesen. In diesem Fall brauchen Sie die Excelvorlage weder herunterladen noch befüllen. Stattdessen laden Sie über die Schaltfläche „VISUM-Datei hochladen“ die Exportdatei aus VISUM hoch. Wie Sie diese erzeugen, erläutert Ihnen das daviplan-Handbuch oder die Anleitung, die Sie über die Schaltfläche „Anleitung VISUM-Datenexport“ herunterladen können. </p>">
      <span class="subtitle1 sub">
        Fahrzeitliste für „{{selectedVariant?.label}}“ zwischen Haltestellen
      </span>
      <table>
        <tr>
          <td i18n>Anzahl Relationen: </td>
          <td>{{this.statistics?.nRelsStopStopTransit?.toLocaleString() || '-'}}</td>
        </tr>
      </table>
      <div style="display: flex; margin-top: 10px;">
        <div style="width: 55%; display: flex; flex-wrap: wrap;">
          <span class="subtitle1 sub" style="margin-top: 10px;">
            Variante 1: Excel
          </span>
          <button mat-stroked-button color="primary"
                  style="margin-top: 10px;"
                  (click)="downloadTemplate(true)">
            <mat-icon>download</mat-icon> Vorlage Fahrzeitenliste
          </button>
          <button mat-flat-button color="primary"
                  style="margin-top: 10px;"
                  (click)="uploadMatrix()">
            <mat-icon>upload</mat-icon> Fahrzeitenliste
          </button>
        </div>
        <mat-divider [vertical]="true" style="margin: 0 20px;"></mat-divider>
        <div style="width: 40%; display: flex; flex-wrap: wrap;">
          <span class="subtitle1 sub"
                style="width: 100%; margin-top: 10px;">
            Variante 2: VISUM
          </span>
          <a mat-stroked-button color="primary"
             style="margin-top: 10px;"
             href="{{backend}}/static/Berechnung_Reisezeitmatrix_Haltestellen_VISUM.pdf"
             target="_blank">
            <mat-icon>menu_book</mat-icon>
            Anleitung
          </a>
          <button mat-flat-button color="primary"
                  style="margin-top: 10px;"
                  (click)="uploadMatrix(true)">
            <mat-icon>upload</mat-icon> VISUM-Datei
          </button>
        </div>
      </div>
    </app-input-card>
    <app-input-card [title]="'Schritt 3: Reisezeitmatrix ÖPNV erzeugen'"
                    [class.hidden]="!selectedVariant"
                    width="450px"
                    [disabled]="isProcessing"
                    infoText="<p>Mit einem Klick auf die Schaltfläche „„Reisezeitmatrix erzeugen“ starten Sie die daviplan-interne Berechnung der ÖPNV-Reisezeitmatrix. Dabei ermittelt daviplan die ÖPNV-Wegezeiten von allen Wohnstandorten (Rasterzellen) in Ihrem Planungsraum und allen Standorten von Infrastruktureinrichtungen.</p>
                    <p>Diesen zeitintensiven Rechenschritt sollten Sie erst durchführen, wenn Sie im Menüpunkt „Infrastrukturdaten > Standorte und Kapazitäten“ bereits alle für Ihr Projekt relevanten Standorte hochgeladen haben. Zwar können Sie auch später noch – z.B. im Zuge der Szenarienentwicklung im Bereich „Infrastrukturplanung“ – einzelne Standorte nachdefinieren. Die Neuberechnung der ÖPNV-Reisezeitmatrix dauert jedoch mitunter länger.</p>">
      <span class="subtitle1 sub">
        Reisezeitmatrix „{{selectedVariant?.label}}“ <br>
        von Wohnstandorten zu Einrichtungen
      </span>
      <table>
        <tr>
          <td i18n>Anzahl Relationen: </td>
          <td>{{this.statistics?.nRelsPlaceCellTransit?.toLocaleString() || '-'}}</td>
        </tr>
      </table>
      <button mat-flat-button color="primary" (click)="createMatrices()">
        <mat-icon>build</mat-icon> Reisezeitmatrix erzeugen
      </button>
    </app-input-card>
  </div>
  <app-input-card subtitle="Daten-Historie Erreichbarkeiten"
                  width="380px"
                  infoText="<p>Die Liste zeigt Ihnen eine Chronik aller Datenimporte und Berechnungen im Bereich „Erreichbarkeiten“.</p>">
    <app-log room="routing" (onMessage)="onMessage($event)" height="350px"></app-log>
  </app-input-card>
</div>

<ng-template #editVariant>
  <form [formGroup]="variantForm">
    <div *ngIf="variantForm.errors">
      <mat-error *ngFor="let error of variantForm.errors | keyvalue" class="alert">
        {{error.key}}: <i>{{error.value}}</i>
      </mat-error>
    </div>
    <div fxLayout="column">
      <mat-form-field appearance="fill">
        <mat-label i18n>Name des Netzes</mat-label>
        <input matInput formControlName="label" required>
      </mat-form-field>
    </div>
  </form>
</ng-template>

<ng-template #fileUploadTemplate let-accept="accept">
  <mat-error *ngFor="let error of uploadErrors | keyvalue" class="alert">
    {{ error.key }}: {{ error.value }}
  </mat-error>
  <input #fileInput type="file" [accept]="accept" (change)="setFiles($event)">
</ng-template>
