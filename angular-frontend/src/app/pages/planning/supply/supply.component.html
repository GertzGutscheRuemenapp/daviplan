<app-scenario-menu domain="supply"></app-scenario-menu>
<mat-expansion-panel cookieExpansion="exp-supply-services">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <div class="mini-fab-icon">
        <div class="davicon icon-GGR-davicons-Font-Simple-3-Standorte-Leistungen"></div>
      </div>
      Standorte / Leistungen
      <app-help-button title="Standorte / Leistungen" position="right">
        <p>Wählen Sie hier im Dropdown-Menü den Infrastrukturbereich und per Checkbox die Leistungen aus dem jeweiligen Infrastrukturbereich aus. Mit dem Klick auf das Filtersymbol können Sie Filter auf Standorte setzen und bearbeiten.</p>
        <p>Cluster, Verdrängung und Zoom auf alle stellen Darstellungsoptionen für die Karte dar.</p>
        <p>Klick auf das Symbol „Neuen Standort hinzufügen“ öffnet einen Dialog um Hinzufügen eines zusätzlichen Standortes.</p>
      </app-help-button>
    </mat-panel-title>
  </mat-expansion-panel-header>
  <div style="padding-bottom: 10px; display: flex;">
    <app-service-select></app-service-select>
    <app-place-filter-button
      #placeFilter
      style="margin-top: 7px;"
      (onFilter)="onFilter()"
      [infrastructure]="this.activeInfrastructure"
      [places]="places"
      [scenario]="activeScenario"
      [year]="year">
<!--        [service]="activeService"-->
    </app-place-filter-button>
  </div>
  <mat-divider></mat-divider>
  <div>
    <ul style="list-style-type: none; margin: 10px 0 10px -28px;">
      <li><mat-slide-toggle color="primary">Cluster</mat-slide-toggle></li>
      <li><mat-slide-toggle color="primary">Verdrängung</mat-slide-toggle></li>
      <li>
        <div class="row-button"
             (click)="zoomToPlaceExtent()">
          <label i18n>Zoom auf alle</label>
          <div class="fill-space"></div>
          <button mat-icon-button color="primary" class="small">
            <mat-icon>location_searching</mat-icon>
          </button>
        </div>
      </li>
    </ul>
  </div>
  <ng-container *ngIf="activeScenario && !activeScenario.isBase">
    <mat-divider></mat-divider>
    <div class="row-button" [ngClass]="{'active': addPlaceMode}" (click)="togglePlaceMode()" style="padding-left: 10px;">
      <label i18n>Neuen Standort hinzufügen</label>
      <div class="fill-space"></div>
      <button color="primary" [ngClass]="{inverted: addPlaceMode}" mat-icon-button class="small">
        <mat-icon class="material-icons-outlined">add_location_alt</mat-icon>
      </button>
    </div>
  </ng-container>
</mat-expansion-panel>
<!--<mat-expansion-panel cookieExpansion="exp-supply-compare" class="disabled">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <div class="mini-fab-icon">
        <div class="davicon icon-GGR-davicons-Font-Simple-4-Vergleichsdarstellung"></div>
      </div>
      Vergleichsdarstellung
      <app-help-button title="Vergleichsdarstellung" position="right">
        <p>Sie können die Angebotsstrukturen das mit dem Zeitslider ausgewählte Jahr vergleichen: Entweder mit den Angebotsstrukturen für ein anderes Jahr oder aber mit der Angebotsstruktur für ein anderes Szenario im selben Jahr. Die Darstellung erfolgt in der Karte.</p>
      </app-help-button>
    </mat-panel-title>
  </mat-expansion-panel-header>
  <mat-checkbox style="padding-left: 12px;" color="primary" [(ngModel)]="compareSupply" i18n> &lt;!&ndash;style="margin-left: -12px"&ndash;&gt;
    Angebotsstrukturen vergleichen
  </mat-checkbox>
  <div class="sub-select-wrapper compare-radio-list">
    <mat-radio-group [(ngModel)]="compareStatus">
      <mat-radio-button value="option 1" color="primary"
                        [disabled]="!compareSupply"
                        i18n>
        Mit Angebotsstrukturen im gleichen Szenario im Jahr
      </mat-radio-button>

      <mat-form-field *ngIf="realYears && prognosisYears" appearance="outline" class="small">
        <mat-label>Jahr</mat-label>
        <mat-select disableOptionCentering disableRipple [value]="realYears[0]" [disabled]="!compareSupply || compareStatus != 'option 1'">
          <mat-option *ngFor="let year of realYears.concat(prognosisYears)" [value]="year">
            {{year}}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-radio-button value="option 2" color="primary"
                        [disabled]="!compareSupply"
                        i18n>
        Mit Angebotsstrukturen im gleichen Jahr im Szenario
      </mat-radio-button>
      <mat-form-field appearance="outline" class="small">
        <mat-select disableOptionCentering disableRipple value="1" [disabled]="!compareSupply || compareStatus != 'option 2'">
          <mat-option value="1">
            Szenario 1
          </mat-option>
          <mat-option value="2">
            Szenario 2
          </mat-option>
        </mat-select>
      </mat-form-field>
    </mat-radio-group>
  </div>
</mat-expansion-panel>-->
<!--workaround to cover visible scenario menu-->
<div style="width: 100%; height:200px; background-color: white;"></div>

<ng-template #placePreviewTemplate><!-- let-place="place">-->
  <ng-container *ngFor="let place of selectedPlaces">
    <b>{{ place.name }}</b>
    <table *ngIf="place.attributes">
      <tr *ngFor="let item of place.attributes | keyvalue">
        <td style="padding-right: 10px;">{{item.key}}</td>
        <td><i>{{item.value}}</i></td>
      </tr>
<!--      <tr *ngIf="activeService">
        <td>Kapazität {{activeService.name}}</td>
        <td><i>{{getFormattedCapacityString([activeService.id], selectedPlace.capacity || 0)}}</i></td>
      </tr>-->
    </table>
    <button *ngIf="place.scenario !== null" mat-button class="mat-button-dv"
            (click)="showEditPlace(place)"
            color="primary">
      Standort editieren
    </button>
    <div *ngIf="activeService">
      <mat-divider style="margin: 10px 0;"></mat-divider>
      Kapazität {{activeService.name}} ({{year}}): <b>{{getFormattedCapacityString([activeService.id], place.capacity || 0)}}</b>
    </div>
    <table *ngVar="getCapacities(place) as capacities" style="margin-top: 10px;">
      <tr *ngFor="let capacity of capacities;">
        <td style="padding-right: 10px;">
          ab {{(capacity.fromYear === 0)? 'Startjahr': capacity.fromYear}}
        </td>
        <td>
          {{capacity.capacity}} {{(capacity.capacity === 1)? activeService?.capacitySingularUnit: activeService?.capacityPluralUnit}}
        </td>
      </tr>
    </table>
    <button *ngIf="!activeScenario?.isBase" mat-button class="mat-button-dv"
            (click)="showEditCapacities(place)"
            color="primary">
      Kapazitäten editieren
    </button>
  </ng-container>
</ng-template>

<ng-template #placeEditTemplate let-place="place">-->
  <form *ngIf="placeForm" [formGroup]="placeForm">
    <mat-form-field appearance="outline" class="full">
      <mat-label i18n>Name</mat-label>
      <input matInput formControlName="name">
    </mat-form-field>
    <div *ngFor="let field of activeInfrastructure?.placeFields">
      <ng-container *ngVar="getFieldType(field) as fieldType">
        <mat-form-field appearance="outline" class="full">
          <mat-label i18n>{{field.name}}</mat-label>
          <input matInput *ngIf="fieldType.ftype === 'STR'" [formControlName]="field.name">
          <input matInput *ngIf="fieldType.ftype === 'NUM'" [formControlName]="field.name" type="number">
          <mat-select *ngIf="fieldType.ftype === 'CLA'" [formControlName]="field.name">
            <mat-option *ngFor="let class of fieldType.classification"
                        [value]="class.value">
              {{class.value}}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </ng-container>
    </div>
  </form>
</ng-template>

<ng-template #placeCapacitiesEditTemplate let-place="place">
  <div><b>Standort "{{ place.name }}"</b></div>
  <div>Leistung "{{ activeService?.name }}"</div>
  <mat-divider style="margin: 10px 0;"></mat-divider>
  <table id="capacityTable">
    <ng-container *ngFor="let capacity of _editCapacities; let i = index;">
      <tr>
        <td style="display: flex; align-items: baseline;">
          <div *ngIf="i === 0 else notStart" style="margin-top: 10px;;">&nbsp;Startjahr&nbsp;</div>
          <ng-template #notStart>
            <mat-form-field appearance="outline" class="small yearInput">
              <mat-label i18n>ab</mat-label>
              <input matInput type="number" required
                     [(ngModel)]="capacity.fromYear"
                     [max]="(i === _editCapacities.length-1)? 9999: _editCapacities[i+1].fromYear-1"
                     [min]="(i>0)? _editCapacities[i-1].fromYear + 1: 0">
            </mat-form-field>
          </ng-template>
          <div *ngIf="i !== _editCapacities.length - 1"
               style="margin-left: auto;">
            bis {{ _editCapacities[i+1].fromYear-1 }}
          </div>
        </td>
        <td>
          <mat-form-field appearance="outline" class="small" style="margin: 0 5px 0 20px;">
            <mat-label i18n>Kapazität</mat-label>
            <input matInput type="number" required
                   [(ngModel)]="capacity.capacity"
                   style="text-align:right;"
                   [min]="0">
          </mat-form-field>
          {{activeService?.capacityPluralUnit}}
        </td>
        <td *ngIf="i > 0">
          <button mat-button color="warn"
                  class="mat-button-dv"
                  (click)="removeEditCap(i)"
                  title="Jahr entfernen">
            <mat-icon>close</mat-icon>
<!--              Jahr entfernen-->
          </button>
        </td>
      </tr>
      <tr style="height: 20px;">
<!--          <ng-container *ngIf="i !== _editCapacities.length - 1">
          <td>
            <mat-divider></mat-divider>
            <div style="position: absolute; margin-top: -15px; background-color: white; padding-right: 10px;">
              bis
            </div>
          </td>
          <td><mat-divider></mat-divider></td>
        </ng-container>-->
        <ng-container *ngIf="i !== _editCapacities.length - 1">
          <td><mat-divider></mat-divider></td>
          <td><mat-divider></mat-divider></td>
        </ng-container>
        <td>
          <button mat-button color="primary"
                  class="mat-button-dv"
                  *ngIf="(i === _editCapacities.length-1) || (_editCapacities[i+1].fromYear - capacity.fromYear > 1) "
                  (click)="insertEditCap(i+1, place)"
                  title="Jahr einfügen" i18n>
            <mat-icon>add</mat-icon>
<!--              Jahr <ng-container *ngIf="i !== _editCapacities.length - 1">einfügen</ng-container>-->
            <ng-container *ngIf="i === _editCapacities.length - 1">Jahr</ng-container>
          </button>
        </td>
      </tr>
    </ng-container>
  </table>
  <mat-divider></mat-divider>
</ng-template>
