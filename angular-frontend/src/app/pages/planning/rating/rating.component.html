<app-scenario-menu domain="rating"></app-scenario-menu>
<mat-expansion-panel cookieExpansion="exp-rating-services">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <div class="mini-fab-icon">
        <div class="davicon icon-GGR-davicons-Font-Simple-3-Standorte-Leistungen"></div>
      </div>
      Leistung
      <mat-icon *ngIf="!planningService.activeService" class="warning"
                title="Keine Leistung ausgewählt">
        error_outline
      </mat-icon>
      <app-help-button title="Leistung" position="right">
        <p>Wählen Sie hier die Leistung aus, für die Sie Indikatoren in der Karte anzeigen möchten.</p>
        <p>Wählen Sie hierzu zunächst im Dropdown-Menü den entsprechenden Infrastrukturbereich und dann per Checkbox die gewünschte Leistung.</p>
      </app-help-button>
    </mat-panel-title>
  </mat-expansion-panel-header>
  <app-service-select></app-service-select>
</mat-expansion-panel>
<mat-expansion-panel cookieExpansion="exp-rating-indicators">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <div class="mini-fab-icon">
        <mat-icon class="material-icons-outlined">lightbulb</mat-icon>
      </div>
      Indikator
      <mat-icon *ngIf="!selectedIndicator" class="warning"
                title="Kein Indikator ausgewählt">
        error_outline
      </mat-icon>
      <app-help-button title="Indikator" position="right">
        <p>Wählen Sie hier aus den definierten Indikatoren für die Darstellung aus.</p>
      </app-help-button>
    </mat-panel-title>
  </mat-expansion-panel-header>
  <mat-form-field appearance="outline" class="small" style="margin-top: 12px;">
    <mat-label>Indikator</mat-label>
    <mat-select disableOptionCentering panelClass="custom-option-panel"
                disableRipple
                [(value)]="selectedIndicator"
                (selectionChange)="onIndicatorChange()"
                [ngbPopover]="selectedIndicator?.description"
                placement="right"
                container="body"
                triggers="mouseenter:mouseleave">
      <mat-option *ngFor="let indicator of indicators"
                  [value]="indicator"
                  [ngbPopover]="indicator.description"
                  placement="right"
                  container="body"
                  triggers="mouseenter:mouseleave">
        {{indicator.title}}
      </mat-option>
    </mat-select>
  </mat-form-field>
  <ng-container *ngIf="selectedIndicator?.additionalParameters">
    <div *ngFor="let parameter of selectedIndicator?.additionalParameters"
         style="margin-top: 10px;">
      <ng-container *ngIf="parameter.type === 'number' || parameter.type === 'string'">
        <mat-form-field class="small" appearance="outline">
          <mat-label>{{parameter.title}}</mat-label>
          <input matInput *ngIf="parameter.type === 'number'" type="number"
                 [value]="indicatorParams[parameter.name] || 0"
                 (change)="setParam(parameter.name, $any($event.target).value)">
          <input matInput *ngIf="parameter.type === 'string'"
                 [value]="indicatorParams[parameter.name] || ''"
                 (change)="setParam(parameter.name, $any($event.target).value!)">
        </mat-form-field>
      </ng-container>
      <ng-container *ngIf="parameter.name === 'mode'">
        <app-mode-select [mode]="indicatorParams['mode']"
                         [label]="parameter.title"
                         (modeChanged)="setParam('mode', $event);">
        </app-mode-select>
      </ng-container>
    </div>
  </ng-container>
</mat-expansion-panel>
<mat-expansion-panel *ngIf="selectedIndicator && selectedIndicator.resultType !== 'area'"
                     cookieExpansion="exp-rating-areas">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <div class="mini-fab-icon">
        <mat-icon class="material-icons-outlined">flip_to_front</mat-icon>
      </div>
      Gebietseinteilung
      <mat-icon *ngIf="!selectedAreaLevel" class="warning"
                title="Keine Gebietseinteilung ausgewählt">
        error_outline
      </mat-icon>
      <app-help-button title="Gebietseinteilung" position="right">
        <p>Wählen Sie hier im Dropdown-Menü die jeweilige Gebietseinteilung für die Darstellung aus.</p>
      </app-help-button>
    </mat-panel-title>
  </mat-expansion-panel-header>
  <mat-form-field appearance="outline" class="small">
    <mat-select disableOptionCentering disableRipple
                [(value)]="selectedAreaLevel"
                (selectionChange)="onAreaLevelChange()">
      <mat-option [value]="areaLevel" *ngFor="let areaLevel of areaLevels">
        {{areaLevel.name}}
      </mat-option>
    </mat-select>
  </mat-form-field>
</mat-expansion-panel>
<!--this div is only there to cover glitched shadow of chart toggle-->
<div style="width: 100%; height: 200px; background-color: white;"></div>
<app-side-toggle [class.hidden]="!(selectedIndicator?.resultType === 'area' || selectedIndicator?.resultType === 'place')"
                 id="chart-toggle" icon="bar_chart" name="Diagramm"
                 cookieExpansion="exp-rating-diagram">
  <div style="position: relative;">
    <div class="diagram-wrapper">
      <app-horizontal-barchart #barChart
                               [showCSVExport]="true"
                               [showPNGExport]="true"
                               xLabel="Jahre"
                               yLabel="Einwohner"
                               [unit]="this.selectedIndicator?.unit || ''"
                               [animate]="true"
                               [title]="this.selectedIndicator?.title || ''"
                               [subtitle]="barChartProps.subtitle">
      </app-horizontal-barchart>
    </div>
    <app-help-button title="Diagrammdarstellung"
                     position="right"
                     style="position: absolute; left: 5px; top: -5px; z-index: 1;">
      <p>Das Diagramm zeigt die Kennwerte des ausgewählten Indikators für alle Gebiete der ausgewählten Gebietseinteilung.</p>
      <p>Mit einem Klick auf den Vollbild-Button rechts oben können Sie sich das Diagramm vergrößert in einem Dialog anzeigen lassen.</p>
      <p>Über den Herunterladen-Button darunter können Sie sich das Diagramm als Bild (PNG) herunterladen.</p>
    </app-help-button>
  </div>
</app-side-toggle>

<ng-template #diagramDialog>
  <div style="overflow-y: auto; max-height: 80vh;">
    <img src="{{backend}}/static/img/Indikator U3 Screenshot.png" width="100%">
  </div>
  <div style="width: 100%; display: flex; justify-content: center;">
    <app-time-slider id="time-slider" [prognosisStart]="2013" [years]="[2009, 2010, 2012, 2013, 2015, 2017, 2020, 2025]"></app-time-slider>
  </div>
</ng-template>
